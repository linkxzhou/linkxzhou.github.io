<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>tcpcopy工具使用 - linkxzhou的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
  
  <meta name="description" content="111">
  
  <meta itemprop="name" content="tcpcopy工具使用 - linkxzhou的博客">
  <meta itemprop="description" content="111">
  <meta itemprop="image" content="https://linkxzhou.github.io/img/author.jpg">
  
  <meta name="twitter:description" content="111" />
  
  <link rel="shortcut icon" href="https://linkxzhou.github.io/img/favicon.ico"/>
  <link rel="apple-touch-icon" href="https://linkxzhou.github.io/apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="https://linkxzhou.github.io/apple-touch-icon.png" />
  <link rel="stylesheet" href="https://linkxzhou.github.io/highlight/styles/github.css">
  <script src="https://linkxzhou.github.io/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <link rel="stylesheet" href="https://linkxzhou.github.io/font/hack/css/hack.min.css">
  <link rel="stylesheet" href="https://linkxzhou.github.io/css/style.css">
</head>

<body>
  <header>
    <div>
  
  <div id="imglogo">
    <a href="https://linkxzhou.github.io/"><img src="https://linkxzhou.github.io/img/logo.svg" alt="linkxzhou的博客" title="linkxzhou的博客"/></a>
  </div>
  
  <div id="textlogo">
    <h1 class="site-name"><a href="https://linkxzhou.github.io/" title="linkxzhou的博客">linkxzhou的博客</a></h1>
    <h2 class="blog-motto">一个追求技术的偏执者</h2>
  </div>
  <div class="navbar"><a class="navbutton navmobile" href="#" title="menu"></a></div>
  <nav class="animated">
    <ul>
      
      <li>
        <form class="search" method="get" action="https://www.google.com/search">
          <div>
            <input type="text" id="search" name="q" placeholder="搜索">
          </div>
        </form>
      </li>
    </ul>
  </nav>
</div>

  </header>
  <div id="container">
    <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody">
    <header class="article-info clearfix">
  <h1 itemprop="name">
      <a href="https://linkxzhou.github.io/post/tcpcopy%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" title="tcpcopy工具使用" itemprop="url">tcpcopy工具使用</a>
  </h1>
  
  <p class="article-time">
    <time datetime="2017-01-12 18:20:42 &#43;0800 CST" itemprop="datePublished">2017年01月12日</time>
  </p>
</header>

	<div class="article-content">
    
    

<h3 id="intercept的使用-10-210-252-77">intercept的使用（10.210.252.77）</h3>

<p>./intercept -F &lsquo;tcp and port 8030&rsquo; -d</p>

<h3 id="tcpcopy的使用-10-191-139-25">tcpcopy的使用（10.191.139.25）</h3>

<p>./tcpcopy -x 8030-10.217.252.221:8030 -s 10.210.252.77 -c 192.168.100.x -d
###路由规则信息（10.217.252.221）
route add -host 10.206.1.50 gw 10.210.252.77
在测试服务器上设置路由：
route add -net 192.168.100.0 netmask 255.255.255.0 gw 10.210.252.77</p>

<p>###tcpcopy使用过程出现rst问题
1.rst包出现的请求出现对端端口没有打开，对端会回复rst或者不回复
2.</p>

<p>###配置过程
（1）安装：
<a href="http://www.tcpdump.org/release/libpcap-1.7.4.tar.gz">http://www.tcpdump.org/release/libpcap-1.7.4.tar.gz</a>
<a href="http://www.netfilter.org/projects/libnfnetlink/files/libnfnetlink-1.0.1.tar.bz2">http://www.netfilter.org/projects/libnfnetlink/files/libnfnetlink-1.0.1.tar.bz2</a>
<a href="http://www.netfilter.org/projects/libmnl/files/libmnl-1.0.3.tar.bz2">http://www.netfilter.org/projects/libmnl/files/libmnl-1.0.3.tar.bz2</a>
<a href="http://www.netfilter.org/projects/libnetfilter_queue/files/libnetfilter_queue-1.0.2.tar.bz2">http://www.netfilter.org/projects/libnetfilter_queue/files/libnetfilter_queue-1.0.2.tar.bz2</a>
（2）配置：
如果提示：
checking for LIBNFNETLINK&hellip; no
configure: error: Package requirements (libnfnetlink &gt;= 0.0.41) were not met:
使用如下配置
export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/
echo &ldquo;/usr/local/lib&rdquo; &gt;&gt; /etc/ld.so.conf
ldconfig
（3）安装intercept
./configure &ndash;traditional &ndash;nfqueue
make
make install
启动./intercept -d
如果提示：./intercept: error while loading shared libraries: libnetfilter_queue.so.1: cannot open shared object file: No such file or directory，需要export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
（4）启动
在测试服务器上设置：
启动iptables监听端口14002的出流量转向到NFQUEUE，供intercept调用
iptables -I OUTPUT -p tcp &ndash;sport 80 -j QUEUE
（5）启动线上服务器的tcpcopy
./tcpcopy -x 8031-10.217.252.221:8030 -s 10.217.252.221 -d
（6）结束tcpcopy使用
1.先要关闭tcpcopy和intercept；
2.查看iptables -L -n &ndash;line-number；
3.iptables -D OUTPUT 上面查看对应的OUTPUT的line number</p>

<p>###tcpcopy原理使用&ndash;代码分析
Tcpcopy拷贝一次流量访问的步骤如下：
①一个访问到达线上前端机；
②socket包在ip层被拷贝了一份传给tcpcopy进程；
③tcpcopy修改包的目的及源地址，发给测试前端机；
④拷贝的包到达测试前端机；
⑤测试前端机的nginx处理访问，并返回结果；
⑥返回结果在ip层被截获、丢弃，由intercpetion拷贝返回结果的ip header返回；
⑦ip header被发送给线上前端机的tcpcopy进程；</p>

<p>1) 首先，在链路层或者IP层，在把包交到上一层之前，系统会检查有没进程创建了socket(AF_PACKET,SOCK_DGRAM,…)
或socket(AF_INET,SOCK_RAW,…)等类型的套接字（即原始套接字sock_raw），如果有，这个包就会被复制一份并发送到这个socket的缓冲区；
tcpcopy就是通过这种方式来复制访问流量的。上述的两种抓包方式，前者工作在数据链路层，后者工作在IP层；
在tcpcopy中不同版本所使用的抓包函数不同，在0.3版本中是：
int sock = socket(AF_PACKET,SOCK_RAW,htons(ETH_P_IP));
而在0.4版本中，用的是：
int sock = socket(AF_INET,SOCK_RAW,IPPROTO_TCP);
以上两个函数分别工作在链路层和IP层，前者会把进来和出去的包都抓取到，后者只  抓取到进来的包。
2）Tcpcopy在发送拷贝的数据包的时候，使用了如下socket：
sock = socket(AF_INET, SOCK_RAW,IPPROTO_RAW);
并对这个socket设置了IP_HDRINCL：
setsockopt(sock, IPPROTO_IP, IP_HDRINCL, &amp;n, sizeof(n));
因此网络层不会再增加ip header. 发送之前更改了包的目的ip和端口：
tcp_header-&gt;dest = remote_port;
ip_header-&gt;daddr = remote_ip;
最后调用sendto函数发送包到测试前端机：
send_len = sendto(sock,(char *)ip_header,tot_len,0,
(struct sockaddr *)&amp;toaddr,sizeof(toaddr));
3）在测试前端机上加载了ip_queue模块，并设置iptables规则：
iptables -I OUTPUT -p tcp –sport 80 -j QUEUE
复制的访问流量到达测试前端机上的nginx，nginx处理并返回结果，这个结果包在IP层会被前面所设置的iptables规则匹配发往目标（target）QUEUE;
而QUEUE是由ip_queue模块实现。下一步这个匹配包就会被内核经过netlink socket发往用户空间的程序（在这是tcpcopy的服务端interception进程）;
netlink socket是内核与用户进程之间的一种通信机制，是网络应用程序与内核通信的最常用的接口，可以用来配置网络的各个方面（比如包的过滤）;
interception用如下方式创建netlink socket：
int sock = socket(AF_NETLINK,SOCK_RAW,NETLINK_FIREWALL);
NETLINK_FIREWALL协议有三种消息类型：IPQM_MODE,IPQM_PACKET,IPQM_VERDICT.
内核通过一个IPQM_PACKET消息将刚才截获的返回结果包发送到interception,interception给内核发送一个IPQM_VERDICT消息告诉内核对这个包的裁决结果（DROP,ACCEPT,etc.）。
tcpcopy通过这样的办法将测试前端机上nginx返回的结果截获丢弃，并由interception返回一个ip header.相应代码实现如下：
拷贝结果包的ip header，发送：
struct receiver_msg_st msg;
&hellip;
memset(msg,0,sizeof(struct receiver_msg_st));
memcpy((void *)(msg.ip_header),ip_header,sizeof(struct iphdr));
memcpy((void *)(msg.tcp_header),tcp_header,sizeof(struct tcphdr));
&hellip;
send(sock,(const void *)msg,sizeof(struct receiver_msg_st),0);</p>

<p>interception向内核发送IPQM_VERDICT消息报告裁决结果：
struct nlmsghdr* nl_header=(struct nlmsghdr*)buffer;
struct ipq_verdict_msg *ver_data = NULL;
struct sockaddr_nl addr;
nl_header-&gt;nlmsg_type=IPQM_VERDICT;
nl_header-&gt;nlmsg_len=NLMSG_LENGTH(sizeof(struct ipq_verdict_msg));
nl_header-&gt;nlmsg_flags=(NLM_F_REQUEST);
nl_header-&gt;nlmsg_pid=getpid();
nl_header-&gt;nlmsg_seq=seq++;
ver_data=(struct ipq_verdict_msg *)NLMSG_DATA(nl_header);
ver_data-&gt;value=NF_DROP; /<em>如果要accept这个包，则设为NF_ACCEPT）</em>/
ver_data-&gt;id=packet_id;
memset(addr, 0, sizeof(addr));
addr.nl_family = AF_NETLINK;
addr.nl_pid = 0;
addr.nl_groups = 0;
sendto(firewall_sock,(void *)nl_header,nl_header-&gt;nlmsg_len,0,
(struct sockaddr *)-&gt;addr,sizeof(struct sockaddr_nl));
内核接收到这个包后将packet_id这个包drop或accept;
在后文中可以看到从0.4版本开始的tcpcopy利用这个特点保留了一个允许访问的ip列表，因为默认情况下访问测试前端机上nginx服务所得到的结果会在ip层被drop掉，造成在80端口上无法访问nginx;
有了这个允许ip列表，即使是刷了iptables规则、起了interception进程，在某些机器上也是可以正常访问测试前端机上的nginx服务的。</p>

	</div>
  <footer class="article-footer clearfix">
  

<div class="article-tags">
  <span></span>
  
  <a href="https://linkxzhou.github.io/tags/tcpcopy">tcpcopy</a>
  
  <a href="https://linkxzhou.github.io/tags/%E6%B5%8B%E8%AF%95">测试</a>
  
</div>





<div class="article-categories">
  <span></span>
  
  <a class="article-category-link" href="https://linkxzhou.github.io/categories/%E7%BD%91%E7%BB%9C">网络</a>
  
</div>



  <div class="article-share" id="share">
    <div data-url="https://linkxzhou.github.io/post/tcpcopy%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" data-title="tcpcopy工具使用" data-tsina="" class="share clearfix">
    </div>
  </div>
</footer>

	</article>
  



</div>

    <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>
<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
  

<div class="categorieslist">
  <p class="asidetitle">分类</p>
  <ul>
    
    <li><a href="https://linkxzhou.github.io/categories/github" title="github">github<sup>1</sup></a></li>
    
    <li><a href="https://linkxzhou.github.io/categories/%e7%bd%91%e7%bb%9c" title="网络">网络<sup>2</sup></a></li>
    
  </ul>
</div>



  

<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
      
			<li><a href="https://linkxzhou.github.io/tags/github" title="github">github<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/go" title="go">go<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/tcpcopy" title="tcpcopy">tcpcopy<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e5%bc%80%e5%8f%91%e8%80%85" title="开发者">开发者<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e5%bc%b1%e7%bd%91" title="弱网">弱网<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e6%b5%8b%e8%af%95" title="测试">测试<sup>2</sup></a></li>
      
		</ul>
</div>



  
  <div class="archiveslist">
    <p class="asidetitle">归档</p>
    <ul class="archive-list">
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://linkxzhou.github.io/post/#2017-01">2017年01月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://linkxzhou.github.io/post/#2016-12">2016年12月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://linkxzhou.github.io/post/#2016-10">2016年10月</a><span class="archive-list-count">1</span>
      </li>
      
    </ul>

  </div>


  

<div class="tagcloudlist">
  <p class="asidetitle">标签云</p>
  <div class="tagcloudlist clearfix">
    
    <a href="https://linkxzhou.github.io/tags/github" style="font-size: 12px;">github</a>
    
    <a href="https://linkxzhou.github.io/tags/go" style="font-size: 12px;">go</a>
    
    <a href="https://linkxzhou.github.io/tags/tcpcopy" style="font-size: 12px;">tcpcopy</a>
    
    <a href="https://linkxzhou.github.io/tags/%e5%bc%80%e5%8f%91%e8%80%85" style="font-size: 12px;">开发者</a>
    
    <a href="https://linkxzhou.github.io/tags/%e5%bc%b1%e7%bd%91" style="font-size: 12px;">弱网</a>
    
    <a href="https://linkxzhou.github.io/tags/%e6%b5%8b%e8%af%95" style="font-size: 12px;">测试</a>
    
  </div>
</div>



  

</aside>
</div>

  </div>
  <footer><div id="footer" >
  
  <div class="line">
    <span></span>
    <div style='background:no-repeat url("https://linkxzhou.github.io/img/author.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  
  
  <section class="info">
    <p>不负春光，野蛮生长</p>
  </section>
  
  <div class="social-font clearfix">
    
    
    
    
    
  </div>
  <p class="copyright">Powered by <a href="http://gohugo.io" target="_blank" title="hugo">hugo</a> and Theme by <a href="https://github.com/coderzh/hugo-pacman-theme" target="_blank" title="hugo-pacman-theme">hugo-pacman-theme</a> © 2017
    
    <a href="https://linkxzhou.github.io/" title="linkxzhou的博客">linkxzhou的博客</a>
    
  </p>
</div>
</footer>
  <script src="https://linkxzhou.github.io/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
done = false;
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  $('form.search').on('submit', function (event) {
    if (false === done) {
      event.preventDefault();
      var orgVal = $(this).find('#search').val();
      $(this).find('#search').val('site:https:\/\/linkxzhou.github.io\/ ' + orgVal);
      done = true;
      $(this).submit();
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});
</script>


<link rel="stylesheet" href="https://linkxzhou.github.io/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="https://linkxzhou.github.io/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>




<script data-no-instant>document.write('<script src="/livereload.js?port=443&mindelay=10"></' + 'script>')</script></body>
</html>
