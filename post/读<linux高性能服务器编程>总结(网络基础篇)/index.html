<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>读&lt;linux高性能服务器编程&gt;总结(网络基础篇) - linkxzhou的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
  
  <meta name="description" content="总结 -- 其实很早之前看完了一遍游双的，一直想结合自己的平常的积累写一些总结，碍于工作太忙，这事情直到现在才开始写总结博文。本书主要分为三个部分">
  
  <meta itemprop="name" content="读&lt;linux高性能服务器编程&gt;总结(网络基础篇) - linkxzhou的博客">
  <meta itemprop="description" content="总结 -- 其实很早之前看完了一遍游双的，一直想结合自己的平常的积累写一些总结，碍于工作太忙，这事情直到现在才开始写总结博文。本书主要分为三个部分">
  <meta itemprop="image" content="https://linkxzhou.github.io/img/author.jpg">
  
  
  <meta name="twitter:description" content="">
  
  <link rel="shortcut icon" href="https://linkxzhou.github.io/img/favicon.ico"/>
  <link rel="apple-touch-icon" href="https://linkxzhou.github.io/apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="https://linkxzhou.github.io/apple-touch-icon.png" />
  <link rel="stylesheet" href="https://linkxzhou.github.io/highlight/styles/github.css">
  <script src="https://linkxzhou.github.io/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <link rel="stylesheet" href="https://linkxzhou.github.io/font/hack/css/hack.min.css">
  <link rel="stylesheet" href="https://linkxzhou.github.io/css/style.css">
</head>

<body>
  <header>
    <div>
  
  <div id="imglogo">
    <a href="https://linkxzhou.github.io/"><img src="https://linkxzhou.github.io/img/logo.svg" alt="linkxzhou的博客" title="linkxzhou的博客"/></a>
  </div>
  
  <div id="textlogo">
    <h1 class="site-name"><a href="https://linkxzhou.github.io/" title="linkxzhou的博客">linkxzhou的博客</a></h1>
    <h2 class="blog-motto">不负春光，野蛮生长</h2>
  </div>
  <div class="navbar"><a class="navbutton navmobile" href="#" title="menu"></a></div>
  <nav class="animated">
    <ul>
      
      <li>
        <form class="search" method="get" action="https://www.google.com/search">
          <div>
            <input type="text" id="search" name="q" placeholder="搜索">
          </div>
        </form>
      </li>
    </ul>
  </nav>
</div>

  </header>
  <div id="container">
    <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody">
    <header class="article-info clearfix">
  <h1 itemprop="name">
      <a href="https://linkxzhou.github.io/post/%E8%AF%BB%3Clinux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B%3E%E6%80%BB%E7%BB%93%28%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%AF%87%29/" title="读&lt;linux高性能服务器编程&gt;总结(网络基础篇)" itemprop="url">读&lt;linux高性能服务器编程&gt;总结(网络基础篇)</a>
  </h1>
  
  <p class="article-time">
    <time datetime="2017-04-01 20:20:42 &#43;0800 CST" itemprop="datePublished">2017年04月01日</time>
  </p>
</header>

	<div class="article-content">
    
    

<!-- 读<linux高性能服务器编程>总结 -->

<p>其实很早之前看完了一遍游双的<linux高性能服务器编程>，一直想结合自己的平常的积累写一些总结，碍于工作太忙，这事情直到现在才开始写总结博文。本书主要分为三个部分，tcp/ip协议，高性能的服务器编程和优化与监控，总的来说：全书比较偏向实践，浅显易懂，适合初中级的后台开发程序员，
但是为了更适合快速了解的读者，我主要对书中的重要部分进行总结和提炼。</p>

<h3 id="第一部分-tcp-ip协议栈之ip协议栈详解">第一部分：tcp／ip协议栈之ip协议栈详解</h3>

<p><strong>(1)tcp/ip协议栈分为四层(或者七层，但是便于大家理解，基本上都是用四层模型)</strong><br />
数据链路层，网络层，传输层和应用层，其中封包的流程是：<br />
应用层数据 &mdash;&gt;<br />
tcp/udp头部(20字节) + 应用层数据 &mdash;&gt;<br />
ip头部(20字节) + tcp/udp头部(20字节) + 应用层数据 &mdash;&gt;<br />
以太网头部(18字节) + ip头部(20字节) + tcp/udp头部(20字节) + 应用层数据<br />
这些数据每一个头部都有自己的协议，并发送到对端模块进行解析，其中对于发送数据大小的要求是有相应的限制，在以太网这一层数据必须46字节-1500字节之间，不足的情况下填充数据，超过的情况下拆分ip包数据；<br />
<strong>(2)arp协议工作原理</strong><br />
主机向自己所在的网络广播一个arp请求，请求获取目标ip地址的物理地址，请求发出后所在的网络(局域网)都会收到这个请求，当匹配该ip请求的机器就主动回包含自己物理地址；
<strong>(3)dns解析原理</strong><br />
tcpdump抓包(tcpdump -i eth0 -nt -s 500 port domain):</p>

<pre><code>08:41:28.266682 IP 192.168.1.100.51468 &gt; 202.96.134.33.53: 42940+ A? www.google.com.hk. (35)
08:41:28.271805 IP 202.96.134.33.53 &gt; 192.168.1.100.51468: 42940 1/0/0 A 93.46.8.89 (51)
08:41:29.827625 IP 192.168.1.100.13671 &gt; 202.96.134.33.53: 14422+ A? sp0.baidu.com. (31)
08:41:29.827843 IP 192.168.1.100.29083 &gt; 202.96.134.33.53: 4498+ A? ss1.baidu.com. (31)
08:41:29.828060 IP 192.168.1.100.38240 &gt; 202.96.134.33.53: 35663+ A? ss2.baidu.com. (31)
08:41:29.828341 IP 192.168.1.100.11330 &gt; 202.96.134.33.53: 42502+ A? www.baidu.com. (31)
08:41:29.828513 IP 192.168.1.100.21489 &gt; 202.96.134.33.53: 20283+ A? ss0.baidu.com. (31)
08:41:29.828710 IP 192.168.1.100.37763 &gt; 202.96.134.33.53: 6612+ A? ss1.bdstatic.com. (34)
08:41:29.838009 IP 202.96.134.33.53 &gt; 192.168.1.100.11330: 42502 2/0/0 A 14.215.177.38, A 14.215.177.37 (63)
08:41:29.839022 IP 202.96.134.33.53 &gt; 192.168.1.100.13671: 14422 2/0/0 A 14.215.177.37, A 14.215.177.38 (63)
</code></pre>

<p>dns是udp协议，192.168.1.100发送dns解析，42940是dns查询标示，+是采用递归查询，A?是使用A类查询(A方式是查找ip，CNAME方式是查询主机别名，PTR是反向查询)；202.96.134.33.53回包解析42940是发送dns解析的标示，1/0/0是1个应答资源，0个授权资源记录和0个额外信息记录，A是A类查询返回，93.46.8.89是返回www.google.com.hk域名的ip地址；
<strong>(4)ip协议</strong><br />
ip是无连接，无状态，不可靠的协议，是tcp/udp的动力，决定了路由和转发的功能，ipv4的头部结构如下：</p>

<pre><code>| 4位版本|4位头部|8位服务类型(TOS)| 16位总长度		|  
| 16位标识                      | 3位标志|13为偏移量	|  
| 8位生存时间|8位协议           | 16位头部校验    		|  
| 32位源端地址                                     	|  
| 32位目标地址                                      	|  
| -----------    选项，最多40个字节    ----------		|  
</code></pre>

<p><strong><em>重点介绍字段:</em></strong><br />
TOS字段分别表示最小延时，最大吞吐量，最高可靠性和最小费用；16位总长度指整个ip数据的长度；8位的TTL生存时间指数据包到目的地之前允许经过的路有跳数，数据报在转发的过程中每次经过一个路由都会-1，当TTL为0时，路由器将其丢弃，并向源端发送icmp的差错报文；<br />
<strong>(5)ip分片和转发</strong><br />
当ip数据报的长度超过帧的MTU时，将会被分片，其中分片可能会发生在发送端，也可能时路由转发阶段；一个ip数据报每个分片具有自己的ip头部，相同的标识值，但是具有不同偏移量，并且出了最后一个分片不带有MF标志，其他的分片都带有MF标志。下面看一个抓包的栗子(ping的数据包，协议是icmp，命令ping www.baidu.com -s 1473[发送1473个数据信息])：</p>

<pre><code>IP (tos 0x0, ttl 64, id 4454, offset 0, flags [+], proto ICMP (1), length 1500)
    192.168.1.100 &gt; 14.215.177.37: ICMP echo request, id 51842, seq 2, length 1480
IP (tos 0x0, ttl 64, id 4454, offset 1480, flags [none], proto ICMP (1), length 21)
    192.168.1.100 &gt; 14.215.177.37: ip-proto-1
</code></pre>

<p>从以上包可以分析tos：最小延时，ttl：64跳，id：4454标识相同，offset：偏移量分别是0和1480，将icmp分片1500(20个ip报头，8个icmp报头，1472数据)和21(20个ip报头，1个icmp数据，由于下一个数据报不需要携带icmp的数据报头)；<br />
本小节还有一个重点是ip数据报在主机上的转发，主机一般都不转发，不过可以设置echo 1 &gt; /proc/sys/net/ipv4/ip_forward，那么转发逻辑如下：</p>

<pre><code>1.检查数据报头部的ttl，如果为0则丢弃该数据包；
2.查看数据报头部的严格路由选择项，如果该项被设置，则检测数据报的目标地址是否为本机的ip，如果不是，则发送icmp源站选路失败报文给发送端；
3.如果有必要，则给源端发送icmp的重定向报文，告诉下一跳ip路由器；
4.将ttl值减1，同时处理其他ip头部选项；
5.如果包超过当前路由器的MTU，则进行ip分片操作；
</code></pre>

<p><strong>(6)ipv6头部结构</strong><br />
ipv6协议是为了解决ipv4不够用的情况，同时增加很多功能，如多播和流功能等，ipv6的头部结构如下(40字节+可变头部)：</p>

<pre><code>| 4位版本|8位头部协议|20位流标签               	|
| 16位长度             |8位下一个包头|8位生存时间  	|
| 128位源端ip地址    ------------------------	|
| 128位目标端ip地址  ------------------------	|
| 扩展数据     ---------------------------------	|
</code></pre>

<p>重点介绍字段：20位流标签是ipv6新增字段，用于对于某些对连接服务质量有特殊要求的通信；ipv6提供了多种扩展数据，如认证头部和加密头部等；</p>

<h3 id="第二部分-tcp-ip协议栈之tcp协议栈详解">第二部分：tcp／ip协议栈之tcp协议栈详解</h3>

<p>tcp协议在我们的应用中非常重要，本小节主要从四方面讨论tcp协议：</p>

<pre><code>1.tcp的头部协议，每个tcp报文都包含20字节的头部字节，指定四元组(目的ip，目的端口，源ip，源端口)；
2.tcp的状态转移，tcp从三次握手到四次挥手过程中状态跳变，如深入理解有助于排查网络问题；
3.tcp的数据流，包括交互数据流，成块数据和紧急数据；
4.tcp数据流的控制，为了保障可靠传输和网络质量，内核对tcp数据进行控制，包括超时重传和拥塞控制；
</code></pre>

<p><strong>(1)tcp数据特点</strong>.
tcp传输是可靠的，首先协议采用应答机制，即对发送端的每个数据报都必须得到对端的应答确认，才认为本次报文传输成功；其次tcp采用超时重传，发送端在发送数据后就启动定时器，如果在定时时间内未收到应答，将重发该数据报；最后tcp报文最终以ip数据报发送，而ip数据报是无序或重复的，那么tcp协议需要对ip层来的数据进行重排和丢弃等操作。<br />
<strong>(2)tcp的头部结构</strong></p>

<pre><code>| 16位的源端口       |16位流标签          	|
| 32位的序号                            	|
| 32位的确认号                           	|
| 4位头部长度|标识位  |16位窗口大小        	|	
| 16位校验和         |16位紧急指针        	|
|------	选项数据，最多40字节	--------|
</code></pre>

<p>32位的序号：一次tcp通讯过程中某个传输方向上字节流的每个字节的编号，初始化阶段为一个随机值，后续的tcp报中的序号设置为初始值+该报文在所携带的数据的第一个字节在整个字节流的偏移量；<br />
32位的确认号：是对端的32位的序号+1；<br />
4位头部长度：标识tcp头部32个字节的大小，由于只有4位，所以tcp头部最长位60字节；<br />
6位标识：URG(紧急指针)，ACK(确认包)，PSH(数据包)，SYN(建立连接包)，FIN(关闭连接包)；<br />
16位窗口大小：指接受通告窗口大小，告诉对端tcp本端接受缓冲区的数据大小，让对端控制发送速度；<br />
16位校验和：tcp的报文crc校验；<br />
16位紧急指针：序号字段的值+该值的下一个字节表示紧急数据的偏移量；<br />
选项数据：在后续的博客中再详细介绍；<br />
具体的数据报栗子：</p>

<pre><code>19:23:14.767712 IP 192.168.1.100.61976 &gt; 139.129.212.166.http: Flags [S], seq 2580028945, win 65535, options [mss 1460,nop,wscale 5,nop,nop,TS val 1032935471 ecr 0,sackOK,eol], length 0
19:23:14.823856 IP 139.129.212.166.http &gt; 192.168.1.100.61976: Flags [S.], seq 3491427708, ack 2580028946, win 14480, options [mss 1360,sackOK,TS val 3615337495 ecr 1032935471,nop,wscale 7], length 0
19:23:14.823905 IP 192.168.1.100.61976 &gt; 139.129.212.166.http: Flags [.], ack 1, win 4128, options [nop,nop,TS val 1032935521 ecr 3615337495], length 0
19:23:20.376906 IP 192.168.1.100.61976 &gt; 139.129.212.166.http: Flags [P.], seq 1:14, ack 1, win 4128, options [nop,nop,TS val 1032940499 ecr 3615337495], length 13: HTTP

说明：可以从上续的第一条请求中看出Flags [S]表示syn包，seq序号2580028945，窗口大小65535*2^5(需要计算options中的wscale 5扩大因子选项)，options是选项字段；
第二条请求是回包数据，Flags [S.]表示syn，ack包，seq序号3491427708，ack确认序号2580028945+1，窗口大小14480*2^7(需要计算options中的wscale 7扩大因子选项)，options是选项字段；
</code></pre>

<p><strong>(2)tcp的状态转移</strong><br />
tcp在建立连接和断开连接分别要经过三次握手和四次挥手，那么都会有相应的服务器端口状态，<linux高性能服务器编程>书中(图3-8)经典的一张tcp状态转移过程，由于图太过于负载，本博客不打算引用，只描述三次握手和四次挥手双端的状态，如图：<br />
<img width="400" height="400" src="data:image/png;base64,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"></p>

<p>服务端状态转移语意：</p>

<blockquote>
<p>a.服务器在listen调用进入LISTEN状态，等待客户端连接；<br />
b.服务器监听到客户端连接，就将该连接放入内核的等待队列，并向客户端发送SYN，ACK报文，进入SYN_RECVD状态，此时客户端处于SYN_SENT阶段；<br />
c.服务器收到客户端的ACK报文，进入ESTABLISHED状态；<br />
d.客户端主动关闭连接(通过close和shutdown发送FIN包)，服务器返回ACK报文后进入CLOSE_WAIT状态；<br />
e.在服务端发送完所有数据给客户端以后(客户端此时只读不写，处于半关闭状态)，发送FIN，ACK到客户端，进入LAST_ACK状态；<br />
f.最后服务端收到客户端发送ACK包后，进入CLOSED状态，关闭连接句柄；</p>
</blockquote>

<p>客户端状态转移语意：</p>

<blockquote>
<p>a.客户端通过connect连接服务器，connect失败后直接进入CLOSED状态，连接成功进入ESTABLISHED状态；<br />
b.客户端向服务端发送FIN包，进入FIN_WAIT_1状态，收到服务端的确认包进入FIN_WAIT_2状态；<br />
c.客户端处于FIN_WAIT_2状态，服务端处于CLOSE_WAIT状态，此时可能处于半关闭，此时服务端可以发送和接收数据，但是客户端只能接受数据；<br />
d.客户端收到服务端的FIN，ACK包后，进入TIME_WAIT，此时客户端要等待2MSL(报文最大生存时间的2倍，一般时2min) ，可能大家比较疑惑，为什么需要TIME_WAIT状态，而且需要等2MSL呢？<br />
TIME_WAIT状态存在原因有两点：其一是可靠的中止tcp连接，其二是保证让延迟的tcp报文有足够的时间被识别。客户端在关闭连接阶段需要处理收到重复的结束报文，然后回复最后的ACK给服务端，否则客户端在收到服务端的FIN就直接回复ACK，这样后续服务端重传的FIN包都会被回复RESET报文，这时服务端认为是错误报文，这就是第一点存在的原因；那么第二点是为了不让同一个tcp端口被多次打开或者是断开以后马上被一个新的连接接管，这样存在数据安全和处理异常等问题，让tcp最大时间坚持2MSL也是为了确保重发和延时的tcp包在这段时间内被丢弃(使用端口复用采用socket选项SO_REUSEADDR)。</p>
</blockquote>

<p><strong>(3)tcp的数据流</strong><br />
往往按照正常的tcp模型&ndash;一个数据包回复一个确认包可能不适应某些生产环境，为了更好的优化tcp模型，下面讨论两种数据交互模型：</p>

<blockquote>
<p>1.交互数据流：对于实时性比较高的应用(如telnet，ssh)，每次发送一个都需要进行数据确认，但是在网络不好的情况下，很多微小的数据包会导致拥塞发送，因此采用Nagle算法(在后续章节介绍)和延时确认(即收到对端的数据包的时候，先不立即发送数据包，等到需要发送数据时候同时发出ACK包，当然这个控制在一定时间范围内)；<br />
2.成块数据流：对于类似ftp协议，多次发送大量的数据，接受端为了加快ACK确认包的顺序，针对多个数据包进行一次确认或者开启SACK(针对需要重传的数据，回复对应的偏移指针)，其中对端发送数据多次发送数据是根据接受端的窗口大小限制的，如果接受端参数win 30084，scale 6，表示还能接收30084*64个字节，其中一次发送16384字节，那么接受端还能同时处理(30084*64)/16384=106个数据包(一般不会发送这么多)；</p>
</blockquote>

<p><strong>(4)tcp超时重传和拥塞控制</strong><br />
tcp服务必须能够重传超时时间内未收到的tcp报文段，为此，tcp模块为每一个tcp报文都维护一个重传定时器，linux两个重传相关的内核参数：<br />
/proc/sys/net/ipv4/tcp_retries1和/proc/sys/net/ipv4/tcp_retries2，前者表示tcp最少执行重传次数，默认为3；后者表示tcp最多执行重传次数，默认为15。<br />
tcp服务有重传必然就会导致拥塞，那么接下来介绍网络底层如何进行拥塞控制？拥塞控制包括四个部分：慢启动，拥塞避免，快速重传和快速恢复；在此之前还需要介绍窗口概念：RNWD(接收窗口，指前面tcp报文中的对端发送的win窗口)，CWND(拥塞窗口，是系统定义的一个状态变量大小)，SWND(发送窗口，是RNWD和CWND之间的较小值)。<br />
在tcp模块刚开始发送数据阶段并不知道网络的实际情况，需要试探性地增加CWND，这一过程称为慢启动，CWND初始值设置为2-4个MSS，然后发送端每次收到接受端的一个确认，就按照公式：CWND += min(N, MSS)，其中N是此次确认中包含的之前未确认的字节数；如果随着CWND不断累加，不加控制会造成网络拥塞，那么需要进行拥塞避免算法，界定慢启动和拥塞避免过程通过慢启动门限(ssthresh)控制，当CWND超过ssthresh则进入拥塞避免阶段；拥塞避免阶段控制CWND是每个RTT时间都计算(如果RTT时间内收到多少确认包)，公式：CWND += MSS*MSS/CWND，这样就保障了CWND缓慢增长，直到传输超时或者tcp重传定时器溢出，就需要重新调整ssthresh，再次进入慢启动阶段，那么ssthresh计算公式：ssthresh = max(FlightSize/2, 2*MSS)，其中FlightSize时已经发送但是还未收到确认的字节数。<br />
另外一种情况：在接受端接收到重复的确认报文段的时候，tcp模块如何处理？如果发送端收到3个重复的确认报文，认为拥塞发生，启动快速重传和快速恢复，先计算ssthresh，然后通过CWND = ssthresh + 3 * MSS计算出CWND，再次每收到1个重复确认时，设置CWND += MSS，最后当收到新数据的确认时，直接设置CWND = ssthresh，这样快速重传和快速恢复完成，又再次进入拥塞避免阶段。</p>

<h3 id="备注">备注</h3>

<p>复位报文产生条件：</p>

<blockquote>
<p>1.访问不存在的端口；<br />
2.异常中止连接，当发送端回复一个RST报文给接受端，接受端所有的排队等待发送的数据都将被丢弃；<br />
3.处于半连接状态写入数据时候，也会回复一个RST报文；</p>
</blockquote>

	</div>
  <footer class="article-footer clearfix">
  

<div class="article-tags">
  <span></span>
  
  <a href="https://linkxzhou.github.io/tags/%E9%AB%98%E6%80%A7%E8%83%BD">高性能</a>
  
  <a href="https://linkxzhou.github.io/tags/%E7%BD%91%E7%BB%9C">网络</a>
  
  <a href="https://linkxzhou.github.io/tags/tcp/ip">tcp/ip</a>
  
</div>





<div class="article-categories">
  <span></span>
  
  <a class="article-category-link" href="https://linkxzhou.github.io/categories/%E7%BD%91%E7%BB%9C">网络</a>
  
</div>



  <div class="article-share" id="share">
    <div data-url="https://linkxzhou.github.io/post/%E8%AF%BB%3Clinux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B%3E%E6%80%BB%E7%BB%93%28%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%AF%87%29/" data-title="读&lt;linux高性能服务器编程&gt;总结(网络基础篇)" data-tsina="" class="share clearfix">
    </div>
  </div>
</footer>

	</article>
  



</div>

    <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>
<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
  

<div class="categorieslist">
  <p class="asidetitle">分类</p>
  <ul>
    
    <li><a href="https://linkxzhou.github.io/categories/github" title="github">github<sup>1</sup></a></li>
    
    <li><a href="https://linkxzhou.github.io/categories/%e7%ae%97%e6%b3%95" title="算法">算法<sup>1</sup></a></li>
    
    <li><a href="https://linkxzhou.github.io/categories/%e7%bd%91%e7%bb%9c" title="网络">网络<sup>4</sup></a></li>
    
  </ul>
</div>



  

<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
      
			<li><a href="https://linkxzhou.github.io/tags/github" title="github">github<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/go" title="go">go<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/http" title="http">http<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/tcp/ip" title="tcp/ip">tcp/ip<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/tcpcopy" title="tcpcopy">tcpcopy<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e5%ad%98%e5%82%a8" title="存储">存储<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e5%bc%80%e5%8f%91%e8%80%85" title="开发者">开发者<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e5%bc%b1%e7%bd%91" title="弱网">弱网<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e6%b5%8b%e8%af%95" title="测试">测试<sup>2</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e7%ae%97%e6%b3%95" title="算法">算法<sup>1</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e7%bd%91%e7%bb%9c" title="网络">网络<sup>2</sup></a></li>
      
			<li><a href="https://linkxzhou.github.io/tags/%e9%ab%98%e6%80%a7%e8%83%bd" title="高性能">高性能<sup>1</sup></a></li>
      
		</ul>
</div>



  
  <div class="archiveslist">
    <p class="asidetitle">归档</p>
    <ul class="archive-list">
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://linkxzhou.github.io/post/#2017-04">2017年04月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://linkxzhou.github.io/post/#2017-03">2017年03月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://linkxzhou.github.io/post/#2016-12">2016年12月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://linkxzhou.github.io/post/#2016-10">2016年10月</a><span class="archive-list-count">1</span>
      </li>
      
    </ul>

  </div>


  

<div class="tagcloudlist">
  <p class="asidetitle">标签云</p>
  <div class="tagcloudlist clearfix">
    
    <a href="https://linkxzhou.github.io/tags/github" style="font-size: 12px;">github</a>
    
    <a href="https://linkxzhou.github.io/tags/go" style="font-size: 12px;">go</a>
    
    <a href="https://linkxzhou.github.io/tags/http" style="font-size: 12px;">http</a>
    
    <a href="https://linkxzhou.github.io/tags/tcp/ip" style="font-size: 12px;">tcp/ip</a>
    
    <a href="https://linkxzhou.github.io/tags/tcpcopy" style="font-size: 12px;">tcpcopy</a>
    
    <a href="https://linkxzhou.github.io/tags/%e5%ad%98%e5%82%a8" style="font-size: 12px;">存储</a>
    
    <a href="https://linkxzhou.github.io/tags/%e5%bc%80%e5%8f%91%e8%80%85" style="font-size: 12px;">开发者</a>
    
    <a href="https://linkxzhou.github.io/tags/%e5%bc%b1%e7%bd%91" style="font-size: 12px;">弱网</a>
    
    <a href="https://linkxzhou.github.io/tags/%e6%b5%8b%e8%af%95" style="font-size: 12px;">测试</a>
    
    <a href="https://linkxzhou.github.io/tags/%e7%ae%97%e6%b3%95" style="font-size: 12px;">算法</a>
    
    <a href="https://linkxzhou.github.io/tags/%e7%bd%91%e7%bb%9c" style="font-size: 12px;">网络</a>
    
    <a href="https://linkxzhou.github.io/tags/%e9%ab%98%e6%80%a7%e8%83%bd" style="font-size: 12px;">高性能</a>
    
  </div>
</div>



  

</aside>
</div>

  </div>
  <footer><div id="footer" >
  
  <div class="line">
    <span></span>
    <div style='background:no-repeat url("https://linkxzhou.github.io/img/author.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  
  
  <section class="info">
    <p>不负春光，野蛮生长</p>
  </section>
  
  <div class="social-font clearfix">
    
    
    
    
    
  </div>
  <p class="copyright">Powered by <a href="http://gohugo.io" target="_blank" title="hugo">hugo</a> and Theme by <a href="https://github.com/coderzh/hugo-pacman-theme" target="_blank" title="hugo-pacman-theme">hugo-pacman-theme</a> © 2017
    
    <a href="https://linkxzhou.github.io/" title="linkxzhou的博客">linkxzhou的博客</a>
    
  </p>
</div>
</footer>
  <script src="https://linkxzhou.github.io/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
done = false;
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  $('form.search').on('submit', function (event) {
    if (false === done) {
      event.preventDefault();
      var orgVal = $(this).find('#search').val();
      $(this).find('#search').val('site:https:\/\/linkxzhou.github.io\/ ' + orgVal);
      done = true;
      $(this).submit();
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});
</script>


<link rel="stylesheet" href="https://linkxzhou.github.io/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="https://linkxzhou.github.io/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>




<script data-no-instant>document.write('<script src="/livereload.js?port=443&mindelay=10"></' + 'script>')</script></body>
</html>
